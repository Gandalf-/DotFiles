#!/bin/bash


error() {

  echo "$@"
  exit 1
}

main() {

  [[ -e ~/.syncdaemon ]] || error '.syncdaemon file does not exist'

  while read -r directory; do

    (
      cd "$directory"
      gstatus="$(git status --porcelain)"
      lastcommit="$(git log --after="yesterday" --oneline | head -n 1)"

      echo "$directory"
      if [[ $gstatus ]]; then

        git add -A :/
        git fetch --all --prune --quiet

        if grep -q 'git sync daemon' <<< "$lastcommit"; then
          echo "time to ammend"
          git commit --amend --no-edit
          git push --force

        else
          git commit -m "git sync daemon - $(whoami)@$(hostname)"
          git rebase --quiet
          git push --quiet
        fi
        exit
      fi
    )

  done < ~/.syncdaemon
}


daemonize() {

  while :; do
    main
    sleep 300
  done
}

foreground=0

case $1 in
  -f|--foreground)
    foreground=1
    ;;
esac

if (( foreground )); then
  daemonize

else
  daemonize &
  disown
fi
